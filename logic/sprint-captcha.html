<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>No Captcha Game</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="../butterfly.css">

<style>
body{
  font-family:'Inter',sans-serif;
}
.game{
  display:flex;
  flex-direction:column;
}
.top{
  display:flex;
  justify-content:space-between;
  padding:12px 16px;
  font-weight:600;
}
.card{
  margin:12px;
  padding:20px;
}
.q{
  font-size:32px;
  text-align:center;
  letter-spacing:6px;
  font-weight:700;
  margin-bottom:12px;
}
.eye-btn{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  font-size:20px;
  cursor:pointer;
  color:#6c757d;
}
.eye-btn:active{
  transform:translateY(-50%) scale(.9);
}
</style>
</head>

<body>

<div class="game p-0">

  <div class="top">
    <span id="timerBox"></span>
    <span id="progress">Played: 0 / 20</span>
  </div>

  <div class="card position-relative">

    <!-- CAPTCHA -->
    <div class="q" id="captchaBox">******</div>

    <!-- INPUT WITH EYE ICON -->
    <div class="position-relative">
      <input
        type="text"
        id="captchaInput"
        class="form-control text-center"
        placeholder="Enter 6 digit captcha"
        maxlength="6"
        autocomplete="off"
        inputmode="numeric"
      >
      <i class="bi bi-eye-fill eye-btn" id="eyeBtn"></i>
    </div>

    <!-- NO TIMER SUBMIT -->
    <button id="submitBtn"
      class="btn btn-outline-primary w-100 mt-3"
      onclick="endGame(true)"
      style="display:none">
      Submit & Finish
    </button>

  </div>
</div>

<script src="../menu.js"></script>
<script src="../answer-feedback.js"></script>

<script>
/* ===== SETTINGS ===== */
const timerOn = localStorage.getItem('timerOn') === '1';
const soundOn = localStorage.getItem('soundOn') === '1';

/* ===== SOUNDS ===== */
const click   = new Howl({ src:['../assets/sound/click.mp3'], volume:.5 });
const correct = new Howl({ src:['../assets/sound/correct.mp3'], volume:.6 });
const wrong   = new Howl({ src:['../assets/sound/wrong.mp3'], volume:.6 });

/* ===== STATE ===== */
let time = 30;
let score = 0;
let index = 0;
const total = 20;
let timerRef = null;
let gameEnded = false;

let captcha = '';
let captchaVisible = false;

/* ===== ELEMENTS ===== */
const timerBox = document.getElementById('timerBox');
const progress = document.getElementById('progress');
const submitBtn = document.getElementById('submitBtn');
const captchaBox = document.getElementById('captchaBox');
const captchaInput = document.getElementById('captchaInput');
const eyeBtn = document.getElementById('eyeBtn');

/* ===== TIMER ===== */
if(timerOn){
  timerBox.innerText = `⏱ ${time}s`;
  timerRef = setInterval(()=>{
    time--;
    timerBox.innerText = `⏱ ${time}s`;
    if(time <= 0) endGame(false);
  },1000);
}else{
  timerBox.innerText = 'No Timer';
  submitBtn.style.display = 'block';
}

/* ===== CAPTCHA ===== */
function generateCaptcha(){
  captcha = Math.floor(100000 + Math.random() * 900000).toString();
}

function showCaptcha(){
  if(captchaVisible) return;
  captchaVisible = true;

  captchaBox.innerText = captcha;

  setTimeout(()=>{
    captchaBox.innerText = '******';
    captchaVisible = false;
  },3000);
}

/* ===== GAME FLOW ===== */
function nextCaptcha(){
  if(gameEnded) return;

  if(index === total){
    endGame(false);
    return;
  }

  index++;
  progress.innerText = `Played: ${index} / ${total}`;
  captchaInput.value = '';

  generateCaptcha();
  showCaptcha();
}

/* ===== INPUT CHECK ===== */
captchaInput.addEventListener('input',()=>{
  if(gameEnded) return;
  if(captchaInput.value.length !== 6) return;

  if(soundOn) click.play();

  if(captchaInput.value === captcha){
    score++;
    if(soundOn) correct.play();
  }else{
    if(soundOn) wrong.play();
  }

  setTimeout(nextCaptcha,600);
});

/* ===== EYE ICON ===== */
eyeBtn.onclick = ()=>{
  if(soundOn) click.play();
  showCaptcha();
};

/* ===== END GAME ===== */
function endGame(manualSubmit){
  if(gameEnded) return;
  gameEnded = true;
  clearInterval(timerRef);

  let allowReward = timerOn ? true : index === total;

  if(allowReward){
    localStorage.setItem('rewardKey',Date.now().toString());
  }

  localStorage.setItem('lastGame','No Captcha');
  localStorage.setItem('lastScore',score);
  localStorage.setItem('lastTotal',total);
  localStorage.setItem('currentGame','captcha');

  location.replace('../result.html');
}

/* ===== START ===== */
nextCaptcha();
</script>

</body>
</html>

